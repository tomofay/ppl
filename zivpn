#!/bin/bash
# ==========================================
#   ZIVPN ULTIMATE INSTALLER (FIXED EDITION)
#   Fixed by: Assistant (Auto-Sync & Anti-Reboot)
#   For Architecture: AMD64 / x86_64
# ==========================================

# --- WARNA ---
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m'

clear
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "       ZIVPN AUTO-INSTALLER (AMD64 FIXED)       "
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"

# ==========================================
#  1. PRE-INSTALL: CEK & HAPUS VERSI LAMA
# ==========================================
echo -e "\n${YELLOW}[1/8] Membersihkan Sistem...${NC}"

if [[ -f /etc/systemd/system/zivpn.service ]] || [[ -d /etc/zivpn ]]; then
    echo -e "   ⚠️  Instalasi lama ditemukan. Menghapus..."
    systemctl stop zivpn >/dev/null 2>&1
    systemctl disable zivpn >/dev/null 2>&1
    rm -f /etc/systemd/system/zivpn.service
    rm -rf /etc/zivpn
    rm -f /usr/local/sbin/zivpn-menu
    rm -f /usr/local/sbin/xp-zivpn
    rm -f /usr/local/bin/zivpn-sync
    
    # Bersihkan Cronjob Lama
    sed -i '/xp-zivpn/d' /var/spool/cron/crontabs/root 2>/dev/null
    sed -i '/limit-quota/d' /var/spool/cron/crontabs/root 2>/dev/null
    
    systemctl daemon-reload
    echo -e "   ✅ Bersih."
else
    echo -e "   ✅ Sistem bersih."
fi

# ==========================================
#  2. INSTALL DEPENDENCIES (CHRONY FIX)
# ==========================================
echo -e "\n${GREEN}[2/8] Menginstall Paket Pendukung...${NC}"
apt-get update -y >/dev/null 2>&1
# Menambahkan jq dan iptables-persistent untuk keperluan Auto-Sync & Routing
apt-get install -y wget curl jq net-tools cron bc chrony iptables iptables-persistent netfilter-persistent openssl >/dev/null 2>&1

systemctl enable chrony >/dev/null 2>&1
systemctl start chrony >/dev/null 2>&1

# ==========================================
#  3. INSTALL CORE ZIVPN (MANUAL FIX)
# ==========================================
echo -e "\n${GREEN}[3/8] Mengunduh Core ZiVPN (AMD64)...${NC}"
mkdir -p /etc/zivpn

# Download Binary AMD64 (Fix Exec Format Error)
wget -q -O /usr/local/bin/zivpn https://github.com/zahidbd2/udp-zivpn/raw/main/bin/zivpn-amd64
chmod +x /usr/local/bin/zivpn

# Buat Config Default secara manual (Aman & Fix Port 5667)
cat > /etc/zivpn/config.json <<EOF
{
  "listen": ":5667",
  "cert": "/etc/zivpn/zivpn.crt",
  "key": "/etc/zivpn/zivpn.key",
  "obfs": "zivpn",
  "auth": {
    "mode": "passwords",
    "config": ["zi"]
  }
}
EOF
chmod 644 /etc/zivpn/config.json

# Generate SSL Cert
openssl req -new -newkey rsa:4096 -days 365 -nodes -x509 -subj "/C=US/ST=California/L=Los Angeles/O=Example Corp/OU=IT Department/CN=zivpn" -keyout "/etc/zivpn/zivpn.key" -out "/etc/zivpn/zivpn.crt" >/dev/null 2>&1

# Optimasi Network
sysctl -w net.core.rmem_max=16777216 >/dev/null 2>&1
sysctl -w net.core.wmem_max=16777216 >/dev/null 2>&1

# ==========================================
#  4. SCRIPT AUTO-SYNC (ANTI-ERROR JAM 12)
# ==========================================
echo -e "${GREEN}[4/8] Memasang Auto-Sync User (Zivpn-Sync)...${NC}"
cat > /usr/local/bin/zivpn-sync << 'EOF'
#!/bin/bash
CONFIG_FILE="/etc/zivpn/config.json"
if [ ! -f "$CONFIG_FILE" ]; then exit 0; fi

while IFS=: read -r username _ uid _ _ _ _; do
    if [[ "$uid" -ge 1000 && "$username" != "nobody" && "$username" != "zi" ]]; then
        if ! jq -e --arg u "$username" '.auth.config | index($u)' "$CONFIG_FILE" >/dev/null 2>&1; then
             jq --arg u "$username" '.auth.config += [$u]' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp"
             mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
        fi
    fi
done < /etc/passwd
EOF
chmod +x /usr/local/bin/zivpn-sync

# ==========================================
#  5. SYSTEMD SERVICE (ANTI-BENGONG REBOOT)
# ==========================================
echo -e "${GREEN}[5/8] Konfigurasi Systemd Service...${NC}"
cat <<EOF > /etc/systemd/system/zivpn.service
[Unit]
Description=zivpn VPN Server
Wants=network-online.target
After=network.target network-online.target

[Service]
Type=simple
User=root
WorkingDirectory=/etc/zivpn
ExecStartPre=/usr/local/bin/zivpn-sync
ExecStart=/usr/local/bin/zivpn server -c /etc/zivpn/config.json
Restart=always
RestartSec=3
Environment=ZIVPN_LOG_LEVEL=info
CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE CAP_NET_RAW
NoNewPrivileges=true

[Install]
WantedBy=multi-user.target
EOF
systemctl daemon-reload

# ==========================================
#  6. IPTABLES ROUTING (REDIRECT PORT)
# ==========================================
echo -e "${GREEN}[6/8] Memasang Routing Iptables (REDIRECT)...${NC}"
# Hapus DNAT lama jika ada agar tidak bentrok
iptables -t nat -D PREROUTING -i $(ip -4 route ls|grep default|grep -Po '(?<=dev )(\S+)'|head -1) -p udp --dport 6000:19999 -j DNAT --to-destination :5667 2>/dev/null

# Pasang Routing REDIRECT yang stabil
iptables -t nat -A PREROUTING -p udp --dport 6000:19999 -j REDIRECT --to-ports 5667
iptables -I INPUT -p udp --dport 5667 -j ACCEPT
iptables -I INPUT -p udp -m multiport --dports 6000:19999 -j ACCEPT

# Simpan Iptables permanen
netfilter-persistent save >/dev/null 2>&1
iptables-save > /etc/iptables.up.rules

# ==========================================
#  7. DATABASE & CRON JOB (XP / AUTO-DELETE)
# ==========================================
echo -e "${GREEN}[7/8] Menyiapkan Database & Auto-Delete...${NC}"
if [ ! -f "/etc/zivpn/user-db.json" ]; then
    echo "{}" > /etc/zivpn/user-db.json
fi

cat <<'EOF' > /usr/local/sbin/xp-zivpn
#!/bin/bash
CONFIG_FILE="/etc/zivpn/config.json"
USER_DB="/etc/zivpn/user-db.json"
SERVICE_NAME="zivpn.service"
now_sec=$(date +%s)

if [[ ! -f "$USER_DB" || ! -f "$CONFIG_FILE" ]]; then exit 0; fi
RESTART_REQUIRED=false

jq -r 'to_entries[] | "\(.key)|\(.value.exp)"' "$USER_DB" | while IFS='|' read -r username exp_date; do
    if [[ "$exp_date" == "null" || -z "$exp_date" ]]; then continue; fi
    exp_sec=$(date -d "$exp_date" +%s 2>/dev/null)
    if [[ $? -ne 0 ]]; then continue; fi
    
    if [[ $exp_sec -lt $now_sec ]]; then
        jq --arg u "$username" '.auth.config -= [$u]' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
        jq --arg u "$username" 'del(.[$u])' "$USER_DB" > "${USER_DB}.tmp" && mv "${USER_DB}.tmp" "$USER_DB"
        RESTART_REQUIRED=true
        echo "$(date): User $username EXPIRED and deleted." >> /var/log/zivpn-xp.log
    fi
done

if [ "$RESTART_REQUIRED" = true ]; then systemctl restart "$SERVICE_NAME"; fi
EOF
chmod +x /usr/local/sbin/xp-zivpn

echo "0 0 * * * /usr/local/sbin/xp-zivpn >> /var/log/xp-zivpn.log 2>&1" >> /var/spool/cron/crontabs/root
if [ -f "/usr/local/sbin/limit-quota" ]; then
    echo "*/5 * * * * /usr/local/sbin/limit-quota >> /dev/null 2>&1" >> /var/spool/cron/crontabs/root
    chmod +x /usr/local/sbin/limit-quota
fi
service cron restart >/dev/null 2>&1

# ==========================================
#  8. FINALISASI & STARTING
# ==========================================
echo -e "\n${GREEN}[8/8] Menjalankan Service...${NC}"

systemctl enable zivpn >/dev/null 2>&1
systemctl start zivpn >/dev/null 2>&1

PORT_ZIVPN=$(grep -o '"listen": *"[^"]*"' /etc/zivpn/config.json | cut -d'"' -f4 | sed 's/://g' | sed 's/0.0.0.0//g')
[ -z "$PORT_ZIVPN" ] && PORT_ZIVPN="5667"

# Fix Exclude Port di UDP Custom (jika ada)
if [ -f "/etc/systemd/system/udp-custom.service" ]; then
    sed -i "s|server -exclude .*|server -exclude 22,53,68,$PORT_ZIVPN|g" /etc/systemd/system/udp-custom.service
    systemctl daemon-reload
    systemctl restart udp-custom
fi

STATUS=$(systemctl is-active zivpn)

clear
echo "============================================"
echo "      ✅ INSTALLASI ZIVPN SELESAI ✅"
echo "============================================"
if [[ "$STATUS" == "active" ]]; then
    echo -e " Status Service : ${GREEN}RUNNING (AMAN)${NC}"
else
    echo -e " Status Service : ${RED}ERROR / STOPPED${NC}"
    echo -e " Cek log dengan : journalctl -u zivpn -n 20"
fi
echo "============================================"
echo " - Config Path  : /etc/zivpn/config.json"
echo " - Binary Path  : /usr/local/bin/zivpn"
echo " - Port ZiVPN   : $PORT_ZIVPN"
echo " - Auto-Sync    : ACTIVE (Anti-Reset)"
echo " - Iptables     : REDIRECT (Anti-Reboot)"
echo "============================================"
